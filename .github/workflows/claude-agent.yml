name: Claude Code Agent (OAuth)

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

env:
  NTFY_URL: https://ntfy.niclasedge.com/alerts
  NTFY_TOKEN: ${{ secrets.NTFY_TOKEN }}

jobs:
  agent-task:
    # Trigger bei neuem Issue mit Label ODER @claude Mention im Kommentar
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'agent-task')) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      # Token-Validierung VOR dem Ausführen
      - name: Check Token Expiry
        id: token_check
        run: |
          EXPIRES_AT="${{ secrets.CLAUDE_EXPIRES_AT }}"
          CURRENT_TIME=$(date +%s)

          if [ -z "$EXPIRES_AT" ]; then
            echo "token_valid=false" >> $GITHUB_OUTPUT
            echo "error_reason=EXPIRES_AT secret not set" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Prüfe ob Token in weniger als 5 Minuten abläuft
          BUFFER=300
          if [ "$CURRENT_TIME" -gt "$((EXPIRES_AT - BUFFER))" ]; then
            echo "token_valid=false" >> $GITHUB_OUTPUT
            EXPIRE_DATE=$(date -d "@$EXPIRES_AT" '+%Y-%m-%d %H:%M:%S' 2>/dev/null || date -r "$EXPIRES_AT" '+%Y-%m-%d %H:%M:%S')
            echo "error_reason=Token expired at $EXPIRE_DATE" >> $GITHUB_OUTPUT
          else
            echo "token_valid=true" >> $GITHUB_OUTPUT
            REMAINING=$((EXPIRES_AT - CURRENT_TIME))
            echo "Token valid for $((REMAINING / 3600)) hours"
          fi

      # ntfy Benachrichtigung bei abgelaufenem Token
      - name: Notify Token Expired
        if: steps.token_check.outputs.token_valid == 'false'
        run: |
          curl -s \
            -H "Authorization: Bearer $NTFY_TOKEN" \
            -H "Title: Claude Code Token Expired" \
            -H "Priority: urgent" \
            -H "Tags: warning,key,claude" \
            -H "Actions: view, Token erneuern, https://github.com/${{ github.repository }}/settings/secrets/actions" \
            -d "OAuth Token ist abgelaufen!

          Repo: ${{ github.repository }}
          Issue: #${{ github.event.issue.number }}
          Grund: ${{ steps.token_check.outputs.error_reason }}

          Bitte Token erneuern:
          1. claude /login
          2. Credentials aus ~/.claude/.credentials.json kopieren
          3. GitHub Secrets aktualisieren" \
            "$NTFY_URL"

      # Issue kommentieren bei Token-Fehler
      - name: Comment on Issue - Token Expired
        if: steps.token_check.outputs.token_valid == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## Claude Code Token Expired

            Der OAuth Token ist abgelaufen und muss erneuert werden.

            **Grund:** ${{ steps.token_check.outputs.error_reason }}

            **So behebst du das:**
            1. Führe \`claude /login\` aus
            2. Kopiere die neuen Credentials aus \`~/.claude/.credentials.json\`
            3. Aktualisiere die GitHub Secrets:
               - \`CLAUDE_ACCESS_TOKEN\`
               - \`CLAUDE_REFRESH_TOKEN\`
               - \`CLAUDE_EXPIRES_AT\`

            Eine ntfy-Benachrichtigung wurde gesendet.`
            });

      - name: Fail if Token Invalid
        if: steps.token_check.outputs.token_valid == 'false'
        run: exit 1

      # Claude Code mit OAuth ausführen
      - name: Run Claude Code Action (OAuth)
        id: claude
        uses: grll/claude-code-action@beta
        continue-on-error: true
        with:
          use_oauth: true
          claude_access_token: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          claude_refresh_token: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          claude_expires_at: ${{ secrets.CLAUDE_EXPIRES_AT }}
          secrets_admin_pat: ${{ secrets.SECRETS_ADMIN_PAT }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          direct_prompt: |
            Arbeite an diesem Issue: ${{ github.event.issue.title }}

            Beschreibung:
            ${{ github.event.issue.body }}

            Erstelle einen PR mit der Lösung falls Code-Änderungen nötig sind.

      # Auth-Fehler erkennen und benachrichtigen
      - name: Check for Auth Errors
        if: failure() || steps.claude.outcome == 'failure'
        id: error_check
        run: |
          # Prüfe ob es ein Auth-Fehler war
          if echo "${{ steps.claude.outputs.error }}" | grep -iE "auth|token|unauthorized|401|expired|invalid_grant"; then
            echo "is_auth_error=true" >> $GITHUB_OUTPUT
          else
            echo "is_auth_error=false" >> $GITHUB_OUTPUT
          fi

      - name: Notify Auth Error via ntfy
        if: steps.error_check.outputs.is_auth_error == 'true'
        run: |
          curl -s \
            -H "Authorization: Bearer $NTFY_TOKEN" \
            -H "Title: Claude Code Auth Error" \
            -H "Priority: urgent" \
            -H "Tags: x,key,claude" \
            -H "Actions: view, Secrets aktualisieren, https://github.com/${{ github.repository }}/settings/secrets/actions" \
            -d "Authentication fehlgeschlagen!

          Repo: ${{ github.repository }}
          Issue: #${{ github.event.issue.number }} - ${{ github.event.issue.title }}

          Der OAuth Token funktioniert nicht mehr.
          Bitte erneuere die Credentials:

          1. claude /login
          2. Neue Tokens aus ~/.claude/.credentials.json
          3. GitHub Secrets aktualisieren" \
            "$NTFY_URL"

      # Erfolgs-Benachrichtigung
      - name: Notify Success via ntfy
        if: steps.claude.outcome == 'success'
        run: |
          curl -s \
            -H "Authorization: Bearer $NTFY_TOKEN" \
            -H "Title: Claude Code Task Done" \
            -H "Priority: default" \
            -H "Tags: white_check_mark,robot,claude" \
            -H "Actions: view, Issue ansehen, ${{ github.event.issue.html_url }}" \
            -d "Task erfolgreich bearbeitet!

          Repo: ${{ github.repository }}
          Issue: #${{ github.event.issue.number }}
          ${{ github.event.issue.title }}" \
            "$NTFY_URL"

      # Allgemeiner Fehler (nicht Auth)
      - name: Notify General Error via ntfy
        if: failure() && steps.error_check.outputs.is_auth_error != 'true'
        run: |
          curl -s \
            -H "Authorization: Bearer $NTFY_TOKEN" \
            -H "Title: Claude Code Error" \
            -H "Priority: high" \
            -H "Tags: x,robot,claude" \
            -H "Actions: view, Workflow ansehen, https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            -d "Task fehlgeschlagen!

          Repo: ${{ github.repository }}
          Issue: #${{ github.event.issue.number }}
          ${{ github.event.issue.title }}

          Siehe Workflow-Logs für Details." \
            "$NTFY_URL"
