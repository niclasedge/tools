name: Claude Code Agent (OAuth)

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  agent-task:
    # Nur wenn agent-task Label hinzugefügt wird
    if: github.event.label.name == 'agent-task'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      # Slack: Workflow gestartet
      - name: Post to Slack - Started
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          if [ -z "$SLACK_BOT_TOKEN" ] || [ -z "$SLACK_CHANNEL_ID" ]; then
            echo "Slack secrets not configured, skipping"
            exit 0
          fi

          curl -s -X POST "https://slack.com/api/chat.postMessage" \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-Type: application/json" \
            -d @- << EOF
          {
            "channel": "$SLACK_CHANNEL_ID",
            "text": "#info :rocket: *Workflow gestartet:* ${{ github.event.issue.title }}\n<${{ github.event.issue.html_url }}|Issue #${{ github.event.issue.number }}> | <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|Logs>"
          }
          EOF

      # Token-Validierung VOR dem Ausführen
      - name: Check Token Expiry
        id: token_check
        run: |
          EXPIRES_AT="${{ secrets.CLAUDE_EXPIRES_AT }}"
          CURRENT_TIME=$(date +%s)

          if [ -z "$EXPIRES_AT" ]; then
            echo "token_valid=false" >> $GITHUB_OUTPUT
            echo "error_reason=EXPIRES_AT secret not set" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Prüfe ob Token in weniger als 5 Minuten abläuft
          BUFFER=300
          if [ "$CURRENT_TIME" -gt "$((EXPIRES_AT - BUFFER))" ]; then
            echo "token_valid=false" >> $GITHUB_OUTPUT
            EXPIRE_DATE=$(date -d "@$EXPIRES_AT" '+%Y-%m-%d %H:%M:%S' 2>/dev/null || date -r "$EXPIRES_AT" '+%Y-%m-%d %H:%M:%S')
            echo "error_reason=Token expired at $EXPIRE_DATE" >> $GITHUB_OUTPUT
          else
            echo "token_valid=true" >> $GITHUB_OUTPUT
            REMAINING=$((EXPIRES_AT - CURRENT_TIME))
            echo "Token valid for $((REMAINING / 3600)) hours"
          fi

      # Issue kommentieren bei Token-Fehler
      - name: Comment on Issue - Token Expired
        if: steps.token_check.outputs.token_valid == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ⚠️ Claude Code Token Expired

            Der OAuth Token ist abgelaufen und muss erneuert werden.

            **Grund:** ${{ steps.token_check.outputs.error_reason }}

            **So behebst du das:**
            1. Führe den OAuth Login Workflow aus
            2. Aktualisiere die GitHub Secrets

            Eine Slack-Benachrichtigung wurde gesendet.`
            });

      - name: Fail if Token Invalid
        if: steps.token_check.outputs.token_valid == 'false'
        run: exit 1

      # Claude Code mit OAuth ausführen
      - name: Run Claude Code Action (OAuth)
        id: claude
        uses: grll/claude-code-action@beta
        continue-on-error: true
        with:
          use_oauth: true
          claude_access_token: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          claude_refresh_token: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          claude_expires_at: ${{ secrets.CLAUDE_EXPIRES_AT }}
          secrets_admin_pat: ${{ secrets.SECRETS_ADMIN_PAT }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          direct_prompt: |
            Arbeite an diesem Issue: ${{ github.event.issue.title }}

            Beschreibung:
            ${{ github.event.issue.body }}

            WICHTIG: Mache NUR die Code-Änderungen. NICHT committen, NICHT pushen, KEINEN PR erstellen, KEINEN Branch erstellen. Das wird automatisch vom Workflow erledigt.

      # PR erstellen falls Änderungen vorhanden
      - name: Create Pull Request
        if: steps.claude.outcome == 'success'
        id: create_pr
        run: |
          # Prüfen ob es Änderungen gibt
          if [ -z "$(git status --porcelain)" ]; then
            echo "Keine Änderungen, kein PR nötig"
            echo "pr_created=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Branch erstellen
          BRANCH_NAME="claude/issue-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH_NAME"

          # Änderungen committen
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "fix: ${{ github.event.issue.title }}

          Closes #${{ github.event.issue.number }}

          Co-Authored-By: Claude <noreply@anthropic.com>"

          # Push und PR erstellen
          git push origin "$BRANCH_NAME"

          PR_URL=$(gh pr create \
            --title "${{ github.event.issue.title }}" \
            --body "## Änderungen

          Automatisch generiert von Claude Code.

          Closes #${{ github.event.issue.number }}

          ---
          *Erstellt via GitHub Actions*" \
            --base main \
            --head "$BRANCH_NAME")

          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "pr_created=true" >> $GITHUB_OUTPUT
          echo "PR erstellt: $PR_URL"
        env:
          GH_TOKEN: ${{ secrets.SECRETS_ADMIN_PAT }}

      # Auth-Fehler erkennen
      - name: Check for Auth Errors
        if: failure() || steps.claude.outcome == 'failure'
        id: error_check
        run: |
          if echo "${{ steps.claude.outputs.error }}" | grep -iE "auth|token|unauthorized|401|expired|invalid_grant"; then
            echo "is_auth_error=true" >> $GITHUB_OUTPUT
          else
            echo "is_auth_error=false" >> $GITHUB_OUTPUT
          fi

      # Letzten Kommentar (Claude's Antwort) holen
      - name: Get Claude's Comment
        if: steps.claude.outcome == 'success'
        id: get_comment
        uses: actions/github-script@v7
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              per_page: 1,
              sort: 'created',
              direction: 'desc'
            });

            if (comments.data.length > 0) {
              const comment = comments.data[0].body;
              // Für Slack: Markdown zu Slack-Format konvertieren (basic)
              const slackText = comment
                .replace(/\*\*/g, '*')  // Bold
                .replace(/`([^`]+)`/g, '`$1`')  // Code
                .substring(0, 3000);  // Slack limit
              core.setOutput('comment', slackText);
              core.setOutput('comment_url', comments.data[0].html_url);
            }

      # Issue schließen bei Erfolg
      - name: Close Issue
        if: steps.claude.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed',
              state_reason: 'completed'
            });

      # Slack Notification mit Claude's Antwort
      - name: Post to Slack
        if: always()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          CLAUDE_COMMENT: ${{ steps.get_comment.outputs.comment }}
          PR_URL: ${{ steps.create_pr.outputs.pr_url }}
          PR_CREATED: ${{ steps.create_pr.outputs.pr_created }}
        run: |
          # Skip wenn keine Slack Secrets gesetzt
          if [ -z "$SLACK_BOT_TOKEN" ] || [ -z "$SLACK_CHANNEL_ID" ]; then
            echo "Slack secrets not configured, skipping notification"
            exit 0
          fi

          # Status bestimmen
          if [ "${{ steps.claude.outcome }}" == "success" ]; then
            STATUS_EMOJI=":white_check_mark:"
            STATUS_TEXT="Erfolgreich"
            COLOR="good"
          elif [ "${{ steps.token_check.outputs.token_valid }}" == "false" ]; then
            STATUS_EMOJI=":key:"
            STATUS_TEXT="Token abgelaufen"
            COLOR="warning"
          elif [ "${{ steps.error_check.outputs.is_auth_error }}" == "true" ]; then
            STATUS_EMOJI=":lock:"
            STATUS_TEXT="Auth Fehler"
            COLOR="danger"
          else
            STATUS_EMOJI=":x:"
            STATUS_TEXT="Fehlgeschlagen"
            COLOR="danger"
          fi

          # Claude's Antwort für JSON escapen
          ESCAPED_COMMENT=$(echo "$CLAUDE_COMMENT" | jq -Rs '.')

          # PR Link hinzufügen falls vorhanden
          if [ "$PR_CREATED" == "true" ] && [ -n "$PR_URL" ]; then
            CONTEXT_TEXT="<${{ github.event.issue.html_url }}|Issue> | <$PR_URL|Pull Request> | <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|Logs>"
          else
            CONTEXT_TEXT="<${{ github.event.issue.html_url }}|Issue #${{ github.event.issue.number }}> | <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|Logs>"
          fi

          # Slack Message senden
          curl -s -X POST "https://slack.com/api/chat.postMessage" \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-Type: application/json" \
            -d @- << EOF
          {
            "channel": "$SLACK_CHANNEL_ID",
            "attachments": [
              {
                "color": "$COLOR",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "#info $STATUS_EMOJI ${{ github.event.issue.title }}",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": $ESCAPED_COMMENT
                    }
                  },
                  {
                    "type": "context",
                    "elements": [
                      {
                        "type": "mrkdwn",
                        "text": "$CONTEXT_TEXT"
                      }
                    ]
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "<@niclasedge>"
                    }
                  }
                ]
              }
            ]
          }
          EOF
